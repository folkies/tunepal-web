import Fundamentals from './models/Fundamentals.es6lib';
import MidiInstruments from './models/MidiInstruments.es6lib';
import TimeSignatures from './models/TimeSignatures.es6lib';
import TunebookManager from './models/TunebookManager.es6lib';
import Utils from './Utils.es6lib';

class _Config {
  constructor() {
    this.Fundamentals = Fundamentals;
    this.MidiInstruments = MidiInstruments;
    this.TimeSignatures = TimeSignatures;
    this.tunebooks = TunebookManager;

    this.CountdownTime = Utils.makeArray(0, 10);
    this.PlaybackSpeed = Utils.makeArray(1, 10);
    this.Transpose = Utils.makeArray(-12, 12);

    this.Properties = Properties;

    this.audioContext = new window.AudioContext();

    this._createProperties();
  }

  _createProperties() {
    this._settings = [];

    for (let property of this.Properties) {
      let storedValue = Utils.getObjectFromStorage(property.name);

      if (storedValue == null) {
        storedValue = property.default;
        Utils.setObjectToStorage(property.name, storedValue);
      }

      this._settings[property.name] = storedValue;

      Object.defineProperty(this, property.name, {
        get: () => this._settings[property.name],
        set: value => {
          if (property.validate != null) {
            let result = property.validate(value);
            if (!result.success) return;
            value = result.value;
          }

          this._settings[property.name] = value;
          Utils.setObjectToStorage(property.name, value);
        },
      });
    }
  }
}

let Properties = [
  {name: 'fundamental', default: 'D'},
  {name: 'sampleTime', default: 12},
  {name: 'enableSampleRateConversion', default: false},
  {name: 'countdownTime', default: 3},
  {name: 'timeSigs', default: 'all'},
  {name: 'melody', default: MidiInstruments[0]},
  {name: 'chords', default: MidiInstruments[0]},
  {name: 'playbackSpeed', default: 5},
  {name: 'transpose', default: 0},
];

let Config = new _Config();

export default Config;
