import Config from '../../Config.es6lib';

export default class TuneController {
  constructor($scope, $rootScope, $routeParams, $http, $timeout) {
    this.$rootScope = $rootScope;
    this.$timeout = $timeout;
    this.config = Config;

    this.loaded = false;
    this.isPlaying = false;
    this.isEditing = false;

    this.tunepalId = $routeParams['id'];
    const url = `${this.config.ApiDomain}/api/Tunes/${this.tunepalId}`;

    $http.get(url)
    .success(data => {
      this.tune = data;
      this.loaded = true;
      this.$timeout(() => this._createAbcEditor());
    });

    $timeout(() => {
      $('.dropdown-button').dropdown({
        constrain_width: false
      });
    });

    $(window).resize(() => this._resizeScore());
  }

  _createAbcEditor() {
    $('#abc').val(this.tune.notation);

    this.abcEditor = new ABCJS.Editor('abc', {
      paper_id: 'score',
      onchange: () => this._resizeScore(),
    });

    this._resizeScore();

    this.tune.titleEncoded = encodeURIComponent(this.tune.title);
  }

  _resizeScore() {
    const score = $('#score');
    const cardScore = $('#card-score');
    const cardContent = $('.score.card-content');
    const scale = cardScore.width() / score.width();
    cardScore.css('transform', `scale(${scale})`);
    cardContent.height(cardScore.height() * scale);
  }

  goBack() {
    if (history.length == 1) {
      location.href = '/#!/record';
    }
    else {
      history.back();
    }
  }

  togglePlaying() {
    this.isPlaying = !this.isPlaying;
  }

  stopPlaying() {
    this.isPlaying = false;
  }

  toggleEditing() {
    this.isEditing = !this.isEditing;

    this.$timeout(() => {
      this._resizeScore();

      // scroll to active element
      const scrollTop = this.isEditing
        ? $('#card-editor').offset().top - $('#card-score').offset().top
        : 0;

      $("html, body").animate({scrollTop: scrollTop}, 500);
    });
  }
}
